name: Build and Release

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - 'README.md'
  pull_request:
    branches: [ "main" ]
    paths-ignore:
      - 'README.md'

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - name: Checkout Code
      [cite_start]uses: actions/checkout@v4 [cite: 1]

    - name: Setup MSYS2
      [cite_start]uses: msys2/setup-msys2@v2 [cite: 1]
      with:
        [cite_start]msystem: MINGW64 [cite: 1]
        [cite_start]update: false [cite: 2]
        [cite_start]install: >- [cite: 2]
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-make
          mingw-w64-x86_64-pkg-config
          mingw-w64-x86_64-SDL2
          mingw-w64-x86_64-SDL2_ttf
          mingw-w64-x86_64-imagemagick
          mingw-w64-x86_64-librsvg
          zip

    - name: Build Project
      [cite_start]shell: msys2 {0} [cite: 3]
      [cite_start]working-directory: src [cite: 3]
      [cite_start]run: mingw32-make [cite: 3]

    - name: Prepare Artifact
      shell: msys2 {0}
      run: |
        mkdir -p release 
        cp build/Pressure-Win64.exe release/ 
        cp build/font.ttf release/ 
        cat LICENSE assets/defaultfont/LICENSE > release/LICENSE 
        zip -rj Pressure-Win64.zip release/*

    - name: Upload Windows Build
      [cite_start]uses: actions/upload-artifact@v4 [cite: 4]
      with:
        [cite_start]name: Pressure-Win64 [cite: 4]
        [cite_start]path: Pressure-Win64.zip [cite: 4]

  build-linux:
    runs-on: ubuntu-latest
    steps:
    - [cite_start]name: Checkout Code [cite: 5]
      [cite_start]uses: actions/checkout@v4 [cite: 5]

    - name: Install Dependencies
      run: |
        sudo apt-get update [cite: 6]
        sudo apt-get install -y libsdl2-dev libsdl2-ttf-dev imagemagick [cite: 6]

    - name: Build Project
      [cite_start]working-directory: src [cite: 6]
      [cite_start]run: make [cite: 6]

    - name: Prepare Artifact
      run: |
        mkdir -p release 
        cp build/Pressure-Linux release/ 
        cp build/font.ttf release/ 
        cat LICENSE assets/defaultfont/LICENSE > release/LICENSE 
        tar -czvf Pressure-Linux-Experimental.tar.gz -C release . 

    - name: Upload Linux Build
      [cite_start]uses: actions/upload-artifact@v4 [cite: 8]
      with:
        [cite_start]name: Pressure-Linux [cite: 8]
        [cite_start]path: Pressure-Linux-Experimental.tar.gz [cite: 8]